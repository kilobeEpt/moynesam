<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой Не Сам - Портал клининговых услуг</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hero-bg { background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1581578735767-152ba4a7e8e1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80'); background-size: cover; background-position: center; }
        .card { transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-link:hover { color: #20C997; }
        .tab-active { background-color: #20C997; color: white; }
        .tab-inactive { background-color: #e5e7eb; color: #374151; }
        .table-hover tbody tr:hover { background-color: #f3f4f6; }
        @media (max-width: 640px) {
            .hero-bg { padding: 2rem 1rem; }
            .card { margin: 1rem 0; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600">Мой Не Сам</div>
            <div class="space-x-4">
                <a href="#" class="nav-link text-gray-700 hover:text-teal-500" onclick="showHome()">Главная</a>
                <a href="#" class="nav-link text-gray-700 hover:text-teal-500" onclick="showAbout()">О нас</a>
                <a href="#" class="nav-link text-gray-700 hover:text-teal-500" onclick="showServices()">Услуги</a>
                <a href="#" class="nav-link text-gray-700 hover:text-teal-500" onclick="showAuth()">Вход</a>
                <a href="#" class="nav-link text-gray-700 hover:text-teal-500" onclick="showRegister()">Регистрация</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Home Page -->
        <div id="home-page" class="fade-in">
            <div class="hero-bg text-white text-center py-16 rounded-lg mb-8">
                <h1 id="home-title" class="text-4xl md:text-5xl font-bold mb-4">Чистота начинается с нас!</h1>
                <p id="home-subtitle" class="text-lg md:text-xl mb-6">Профессиональные клининговые услуги для вашего дома и офиса.</p>
                <button onclick="showRegister()" class="bg-teal-500INGS text-white px-6 py-3 rounded-full hover:bg-teal-600">Заказать уборку</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card bg-white p-6 rounded-lg shadow-md">
                    <i class="fas fa-broom text-4xl text-blue-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Быстро и качественно</h3>
                    <p>Наши специалисты обеспечат идеальную чистоту в кратчайшие сроки.</p>
                </div>
                <div class="card bg-white p-6 rounded-lg shadow-md">
                    <i class="fas fa-shield-alt text-4xl text-blue-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Безопасные материалы</h3>
                    <p>Используем экологичные и безопасные средства для уборки.</p>
                </div>
                <div class="card bg-white p-6 rounded-lg shadow-md">
                    <i class="fas fa-clock text-4xl text-blue-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Гибкий график</h3>
                    <p>Выбирайте удобное время для уборки, мы подстроимся под вас.</p>
                </div>
            </div>
        </div>

        <!-- About Page -->
        <div id="about-page" class="fade-in hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">О нас</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <p id="about-content" class="text-gray-600">«Мой Не Сам» — это ваш надежный партнер в создании чистоты и уюта. Мы предлагаем широкий спектр клининговых услуг для жилых и коммерческих помещений. Наша миссия — сделать вашу жизнь проще и комфортнее, предоставляя профессиональные услуги по уборке. С 2023 года мы помогаем тысячам клиентов поддерживать чистоту, используя современное оборудование и экологичные материалы. Доверьте уборку нам и наслаждайтесь свободным временем!</p>
            </div>
        </div>

        <!-- Services Page -->
        <div id="services-page" class="fade-in hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Наши услуги</h2>
            <div id="services-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>

        <!-- Registration Form -->
        <div id="register-form" class="fade-in hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Регистрация</h2>
            <div id="register-error" class="text-red-500 mb-4"></div>
            <input type="text" id="reg-login" placeholder="Логин" class="w-full p-3 mb-4 border rounded-lg" required>
            <input type="password" id="reg-password" placeholder="Пароль (мин. 6 символов)" class="w-full p-3 mb-4 border rounded-lg" required>
            <input type="text" id="reg-fullname" placeholder="ФИО" class="w-full p-3 mb-4 border rounded-lg" required>
            <input type="text" id="reg-phone" placeholder="Телефон (+7(XXX)-XXX-XX-XX)" class="w-full p-3 mb-4 border rounded-lg" required>
            <input type="email" id="reg-email" placeholder="Email" class="w-full p-3 mb-4 border rounded-lg" required>
            <button onclick="register()" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600">Зарегистрироваться</button>
            <p class="mt-4">Уже есть аккаунт? <a href="#" class="text-blue-600 hover:underline" onclick="showAuth()">Войти</a></p>
        </div>

        <!-- Authorization Form -->
        <div id="auth-form" class="fade-in hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Авторизация</h2>
            <div id="auth-error" class="text-red-500 mb-4"></div>
            <input type="text" id="auth-login" placeholder="Логин" class="w-full p-3 mb-4 border rounded-lg" required>
            <input type="password" id="auth-password" placeholder="Пароль" class="w-full p-3 mb-4 border rounded-lg" required>
            <button onclick="login()" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600">Войти</button>
            <p class="mt-4">Нет аккаунта? <a href="#" class="text-blue-600 hover:underline" onclick="showRegister()">Зарегистрироваться</a></p>
        </div>

        <!-- Orders Page -->
        <div id="orders-page" class="fade-in hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Мои заявки</h2>
            <button onclick="showOrderForm()" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600 mb-4">Создать заявку</button>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <table class="w-full table-hover">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-3 text-left">Адрес</th>
                            <th class="p-3 text-left">Услуга</th>
                            <th class="p-3 text-left">Дата и время</th>
                            <th class="p-3 text-left">Оплата</th>
                            <th class="p-3 text-left">Статус</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body"></tbody>
                </table>
            </div>
            <button onclick="logout()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 mt-4">Выйти</button>
        </div>

        <!-- Order Form -->
        <div id="order-form" class="fade-in hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Новая заявка</h2>
            <div id="order-error" class="text-red-500 mb-4"></div>
            <input type="text" id="order-address" placeholder="Адрес" class="w-full p-3 mb-4 border rounded-lg" required>
            <input type="text" id="order-phone" placeholder="Телефон (+7(XXX)-XXX-XX-XX)" class="w-full p-3 mb-4 border rounded-lg" required>
            <select id="order-service" class="w-full p-3 mb-4 border rounded-lg" required>
                <option value="">Выберите услугу</option>
            </select>
            <label class="flex items-center mb-4">
                <input type="checkbox" id="other-service-check" onclick="toggleOtherService()" class="mr-2"> Иная услуга
            </label>
            <textarea id="other-service" placeholder="Опишите услугу" class="w-full p-3 mb-4 border rounded-lg hidden"></textarea>
            <input type="datetime-local" id="order-datetime" class="w-full p-3 mb-4 border rounded-lg" required>
            <select id="order-payment" class="w-full p-3 mb-4 border rounded-lg" required>
                <option value="">Тип оплаты</option>
                <option value="наличные">Наличные</option>
                <option value="банковская карта">Банковская карта</option>
            </select>
            <button onclick="submitOrder()" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600">Отправить заявку</button>
            <button onclick="showOrders()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 ml-2">Назад</button>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="fade-in hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Панель администратора</h2>
            <div class="flex tabs mb-4">
                <button class="px-4 py-2 rounded-l-lg tab-inactive" onclick="showAdminTab('orders')" id="tab-orders">Заявки</button>
                <button class="px-4 py-2 tab-inactive" onclick="showAdminTab('users')" id="tab-users">Пользователи</button>
                <button class="px-4 py-2 rounded-r-lg tab-inactive" onclick="showAdminTab('content')" id="tab-content">Контент</button>
            </div>
            <!-- Orders Tab -->
            <div id="admin-orders" class="bg-white p-6 rounded-lg shadow-md">
                <table class="w-full table-hover">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-3 text-left">ФИО</th>
                            <th class="p-3 text-left">Адрес</th>
                            <th class="p-3 text-left">Телефон</th>
                            <th class="p-3 text-left">Услуга</th>
                            <th class="p-3 text-left">Дата и время</th>
                            <th class="p-3 text-left">Оплата</th>
                            <th class="p-3 text-left">Статус</th>
                            <th class="p-3 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="admin-orders-table-body"></tbody>
                </table>
            </div>
            <!-- Users Tab -->
            <div id="admin-users" class="bg-white p-6 rounded-lg shadow-md hidden">
                <table class="w-full table-hover">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-3 text-left">Логин</th>
                            <th class="p-3 text-left">ФИО</th>
                            <th class="p-3 text-left">Телефон</th>
                            <th class="p-3 text-left">Email</th>
                            <th class="p-3 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-table-body"></tbody>
                </table>
            </div>
            <!-- Content Tab -->
            <div id="admin-content" class="bg-white p-6 rounded-lg shadow-md hidden">
                <h3 class="text-xl font-semibold mb-4">Управление услугами</h3>
                <div class="mb-6">
                    <input type="text" id="new-service" placeholder="Название новой услуги" class="w-full p-3 mb-4 border rounded-lg">
                    <button onclick="addService()" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600">Добавить услугу</button>
                    <div id="services-error" class="text-red-500 mt-2"></div>
                </div>
                <table class="w-full table-hover mb-6">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-3 text-left">Название услуги</th>
                            <th class="p-3 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody id="admin-services-table-body"></tbody>
                </table>
                <h3 class="text-xl font-semibold mb-4">Управление контентом</h3>
                <div id="content-error" class="text-red-500 mb-4"></div>
                <label class="block mb-2">Заголовок главной страницы</label>
                <input type="text" id="content-home-title" class="w-full p-3 mb-4 border rounded-lg">
                <label class="block mb-2">Подзаголовок главной страницы</label>
                <input type="text" id="content-home-subtitle" class="w-full p-3 mb-4 border rounded-lg">
                <label class="block mb-2">Текст страницы "О нас"</label>
                <textarea id="content-about" class="w-full p-3 mb-4 border rounded-lg" rows="5"></textarea>
                <button onclick="updateContent()" class="bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600">Сохранить изменения</button>
            </div>
            <button onclick="logout()" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 mt-4">Выйти</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4">Мой Не Сам</h3>
                    <p>Профессиональные клининговые услуги для вашего комфорта.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Контакты</h3>
                    <p>Email: info@moynesam.ru</p>
                    <p>Телефон: +7(800)-123-45-67</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Ссылки</h3>
                    <a href="#" class="block hover:text-teal-500" onclick="showHome()">Главная</a>
                    <a href="#" class="block hover:text-teal-500" onclick="showAbout()">О нас</a>
                    <a href="#" class="block hover:text-teal-500" onclick="showServices()">Услуги</a>
                </div>
            </div>
            <div class="mt-6 text-center">
                <p>© 2025 Мой Не Сам. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <script>
        let token = localStorage.getItem('token');
        let userId = localStorage.getItem('userId');
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        let currentAdminTab = 'orders';

        function showHome() {
            hideAll();
            document.getElementById('home-page').classList.remove('hidden');
            fetchContent();
        }

        function showAbout() {
            hideAll();
            document.getElementById('about-page').classList.remove('hidden');
            fetchContent();
        }

        function showServices() {
            hideAll();
            document.getElementById('services-page').classList.remove('hidden');
            fetchServices();
        }

        function showRegister() {
            hideAll();
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showAuth() {
            hideAll();
            document.getElementById('auth-form').classList.remove('hidden');
        }

        function showOrders() {
            hideAll();
            document.getElementById('orders-page').classList.remove('hidden');
            fetchOrders();
        }

        function showOrderForm() {
            hideAll();
            document.getElementById('order-form').classList.remove('hidden');
            fetchServicesForOrder();
        }

        function showAdminPanel() {
            hideAll();
            document.getElementById('admin-panel').classList.remove('hidden');
            showAdminTab('orders');
        }

        function showAdminTab(tab) {
            currentAdminTab = tab;
            document.getElementById('admin-orders').classList.add('hidden');
            document.getElementById('admin-users').classList.add('hidden');
            document.getElementById('admin-content').classList.add('hidden');
            document.getElementById(`tab-orders`).classList.remove('tab-active');
            document.getElementById(`tab-users`).classList.remove('tab-active');
            document.getElementById(`tab-content`).classList.remove('tab-active');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`admin-${tab}`).classList.remove('hidden');
            if (tab === 'orders') fetchAdminOrders();
            if (tab === 'users') fetchUsers();
            if (tab === 'content') {
                fetchServicesForAdmin();
                fetchContentForAdmin();
            }
        }

        function hideAll() {
            document.querySelectorAll('.fade-in').forEach(el => el.classList.add('hidden'));
        }

        function toggleOtherService() {
            const checkbox = document.getElementById('other-service-check');
            const textarea = document.getElementById('other-service');
            textarea.classList.toggle('hidden', !checkbox.checked);
            textarea.required = checkbox.checked;
        }

        async function fetchContent() {
            try {
                const response = await fetch('/api/content');
                const content = await response.json();
                document.getElementById('home-title').textContent = content.home_title || 'Чистота начинается с нас!';
                document.getElementById('home-subtitle').textContent = content.home_subtitle || 'Профессиональные клининговые услуги для вашего дома и офиса.';
                document.getElementById('about-content').textContent = content.about_content || '«Мой Не Сам» — это ваш надежный партнер в создании чистоты и уюта...';
            } catch (e) {
                console.error('Ошибка загрузки контента');
            }
        }

        async function fetchContentForAdmin() {
            try {
                const response = await fetch('/api/content', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const content = await response.json();
                document.getElementById('content-home-title').value = content.home_title || '';
                document.getElementById('content-home-subtitle').value = content.home_subtitle || '';
                document.getElementById('content-about').value = content.about_content || '';
            } catch (e) {
                console.error('Ошибка загрузки контента для админа');
            }
        }

        async function fetchServices() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();
                const list = document.getElementById('services-list');
                list.innerHTML = '';
                services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'card bg-white p-6 rounded-lg shadow-md';
                    div.innerHTML = `
                        <img src="https://images.unsplash.com/photo-1581578735767-152ba4a7e8e1?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="${service.name}" class="w-full h-48 object-cover rounded-t-lg mb-4">
                        <h3 class="text-xl font-semibold mb-2">${service.name}</h3>
                        <p class="text-gray-600">Профессиональная услуга для вашего комфорта.</p>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error('Ошибка загрузки услуг');
            }
        }

        async function fetchServicesForOrder() {
            try {
                const response = await fetch('/api/services');
                const services = await response.json();
                const select = document.getElementById('order-service');
                select.innerHTML = '<option value="">Выберите услугу</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.name;
                    option.textContent = service.name;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Ошибка загрузки услуг для заказа');
            }
        }

        async function fetchServicesForAdmin() {
            try {
                const response = await fetch('/api/services', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const services = await response.json();
                const tbody = document.getElementById('admin-services-table-body');
                tbody.innerHTML = '';
                services.forEach(service => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">${service.name}</td>
                        <td class="p-3">
                            <button onclick="deleteService(${service.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Ошибка загрузки услуг для админа');
            }
        }

        async function addService() {
            const name = document.getElementById('new-service').value;
            const errorDiv = document.getElementById('services-error');
            if (!name || name.length < 3) {
                errorDiv.textContent = 'Название услуги должно быть не короче 3 символов';
                return;
            }
            try {
                const response = await fetch('/api/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name })
                });
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('new-service').value = '';
                    errorDiv.className = 'text-green-500';
                    errorDiv.textContent = result.message;
                    fetchServicesForAdmin();
                } else {
                    errorDiv.textContent = result.error || 'Ошибка добавления услуги';
                }
            } catch (e) {
                errorDiv.textContent = 'Ошибка сервера';
            }
        }

        async function deleteService(id) {
            if (!confirm('Вы уверены, что хотите удалить эту услугу?')) return;
            try {
                const response = await fetch(`/api/services/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (response.ok) {
                    fetchServicesForAdmin();
                } else {
                    alert(result.error || 'Ошибка удаления услуги');
                }
            } catch (e) {
                alert('Ошибка сервера');
            }
        }

        async function updateContent() {
            const homeTitle = document.getElementById('content-home-title').value;
            const homeSubtitle = document.getElementById('content-home-subtitle').value;
            const aboutContent = document.getElementById('content-about').value;
            const errorDiv = document.getElementById('content-error');
            if (!homeTitle || !homeSubtitle || !aboutContent) {
                errorDiv.textContent = 'Все поля должны быть заполнены';
                return;
            }
            try {
                const response = await fetch('/api/content', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        home_title: homeTitle,
                        home_subtitle: homeSubtitle,
                        about_content: aboutContent
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    errorDiv.className = 'text-green-500';
                    errorDiv.textContent = result.message;
                    fetchContent();
                } else {
                    errorDiv.textContent = result.error || 'Ошибка обновления контента';
                }
            } catch (e) {
                errorDiv.textContent = 'Ошибка сервера';
            }
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await response.json();
                const tbody = document.getElementById('admin-users-table-body');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">${user.login}</td>
                        <td class="p-3">${user.full_name}</td>
                        <td class="p-3">${user.phone}</td>
                        <td class="p-3">${user.email}</td>
                        <td class="p-3">
                            <button onclick="deleteUser(${user.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Ошибка загрузки пользователей');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) return;
            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (response.ok) {
                    fetchUsers();
                } else {
                    alert(result.error || 'Ошибка удаления пользователя');
                }
            } catch (e) {
                alert('Ошибка сервера');
            }
        }

        async function register() {
            const login = document.getElementById('reg-login').value;
            const password = document.getElementById('reg-password').value;
            const fullname = document.getElementById('reg-fullname').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const errorDiv = document.getElementById('register-error');

            if (!login || login.length < 3) {
                errorDiv.textContent = 'Логин должен быть не короче 3 символов';
                return;
            }
            if (!password || password.length < 6) {
                errorDiv.textContent = 'Пароль должен быть не короче 6 символов';
                return;
            }
            if (!fullname.match(/^[А-Яа-я\s]+$/)) {
                errorDiv.textContent = 'ФИО должно содержать только кириллицу и пробелы';
                return;
            }
            if (!phone.match(/^\+7\(\d{3}\)-\d{3}-\d{2}-\d{2}$/)) {
                errorDiv.textContent = 'Телефон должен быть в формате +7(XXX)-XXX-XX-XX';
                return;
            }
            if (!email.match(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/)) {
                errorDiv.textContent = 'Некорректный формат email';
                return;
            }

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password, full_name: fullname, phone, email })
                });
                const result = await response.json();
                if (response.ok) {
                    errorDiv.className = 'text-green-500';
                    errorDiv.textContent = result.message;
                    setTimeout(showAuth, 2000);
                } else {
                    errorDiv.textContent = result.error || 'Ошибка регистрации';
                }
            } catch (e) {
                errorDiv.textContent = 'Ошибка сервера';
            }
        }

        async function login() {
            const login = document.getElementById('auth-login').value;
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('auth-error');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login, password })
                });
                const result = await response.json();
                if (response.ok) {
                    token = result.token;
                    userId = result.userId;
                    isAdmin = result.isAdmin;
                    localStorage.setItem('token', token);
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('isAdmin', isAdmin);
                    if (isAdmin) {
                        showAdminPanel();
                    } else {
                        showOrders();
                    }
                } else {
                    errorDiv.textContent = result.error || 'Неверный логин или пароль';
                }
            } catch (e) {
                errorDiv.textContent = 'Ошибка сервера';
            }
        }

        async function fetchOrders() {
            try {
                const response = await fetch('/api/orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await response.json();
                const tbody = document.getElementById('orders-table-body');
                tbody.innerHTML = '';
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">${order.address}</td>
                        <td class="p-3">${order.service_type}${order.other_service ? ` (${order.other_service})` : ''}</td>
                        <td class="p-3">${new Date(order.date_time).toLocaleString()}</td>
                        <td class="p-3">${order.payment_type}</td>
                        <td class="p-3">${order.status}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Ошибка загрузки заявок');
            }
        }

        async function submitOrder() {
            const address = document.getElementById('order-address').value;
            const phone = document.getElementById('order-phone').value;
            const service = document.getElementById('order-service').value;
            const otherService = document.getElementById('other-service-check').checked ? document.getElementById('other-service').value : '';
            const datetime = document.getElementById('order-datetime').value;
            const payment = document.getElementById('order-payment').value;
            const errorDiv = document.getElementById('order-error');

            if (!address) {
                errorDiv.textContent = 'Укажите адрес';
                return;
            }
            if (!phone.match(/^\+7\(\d{3}\)-\d{3}-\d{2}-\d{2}$/)) {
                errorDiv.textContent = 'Телефон должен быть в формате +7(XXX)-XXX-XX-XX';
                return;
            }
            if (!service && !otherService) {
                errorDiv.textContent = 'Выберите услугу или укажите иную';
                return;
            }
            if (!datetime) {
                errorDiv.textContent = 'Укажите дату и время';
                return;
            }
            if (!payment) {
                errorDiv.textContent = 'Выберите тип оплаты';
                return;
            }

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address,
                        phone,
                        service_type: service,
                        other_service: otherService,
                        date_time: datetime,
                        payment_type: payment
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    errorDiv.className = 'text-green-500';
                    errorDiv.textContent = result.message;
                    setTimeout(showOrders, 2000);
                } else {
                    errorDiv.textContent = result.error || 'Ошибка создания заявки';
                }
            } catch (e) {
                errorDiv.textContent = 'Ошибка сервера';
            }
        }

        async function fetchAdminOrders() {
            try {
                const response = await fetch('/api/admin-orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await response.json();
                const tbody = document.getElementById('admin-orders-table-body');
                tbody.innerHTML = '';
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">${order.full_name}</td>
                        <td class="p-3">${order.address}</td>
                        <td class="p-3">${order.phone}</td>
                        <td class="p-3">${order.service_type}${order.other_service ? ` (${order.other_service})` : ''}</td>
                        <td class="p-3">${new Date(order.date_time).toLocaleString()}</td>
                        <td class="p-3">${order.payment_type}</td>
                        <td class="p-3">${order.status}</td>
                        <td class="p-3">
                            <select onchange="updateStatus(${order.id}, this.value)" class="p-2 border rounded">
                                <option value="новая" ${order.status === 'новая' ? 'selected' : ''}>Новая</option>
                                <option value="в работе" ${order.status === 'в работе' ? 'selected' : ''}>В работе</option>
                                <option value="выполнено" ${order.status === 'выполнено' ? 'selected' : ''}>Выполнено</option>
                                <option value="отменено" ${order.status === 'отменено' ? 'selected' : ''}>Отменено</option>
                            </select>
                            ${order.status === 'отменено' ? `<input type="text" value="${order.cancel_reason || ''}" onchange="updateCancelReason(${order.id}, this.value)" class="p-2 border rounded mt-2">` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Ошибка загрузки заявок администратора');
            }
        }

        async function updateStatus(orderId, status) {
            let cancelReason = '';
            if (status === 'отменено') {
                cancelReason = prompt('Укажите причину отмены:');
                if (!cancelReason) return;
            }
            try {
                const response = await fetch('/api/admin-orders', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: orderId, status, cancel_reason: cancelReason })
                });
                const result = await response.json();
                if (response.ok) {
                    fetchAdminOrders();
                } else {
                    alert(result.error || 'Ошибка обновления статуса');
                }
            } catch (e) {
                alert('Ошибка сервера');
            }
        }

        async function updateCancelReason(orderId, reason) {
            try {
                const response = await fetch('/api/admin-orders', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: orderId, cancel_reason: reason })
                });
                const result = await response.json();
                if (response.ok) {
                    fetchAdminOrders();
                } else {
                    alert(result.error || 'Ошибка обновления причины');
                }
            } catch (e) {
                alert('Ошибка сервера');
            }
        }

        async function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('isAdmin');
            token = null;
            userId = null;
            isAdmin = false;
            showAuth();
        }

        showHome();
    </script>
</body>
</html>